<section>
    VmInclude:__COMPONENT__/g/grid.01.html
</section>
<script>
    function F__ID(){
        //-------------------------------------
        //VmInclude:__COMPONENT__/g/grid.01.js
        //VmInclude:__CURRENT_PATH__data.html.lab_manager_approval.js
        //VmInclude:__CURRENT_PATH__data.html.supervisor_approval.js
        //VmInclude:__CURRENT_PATH__data.html.financial_approval.js
        //VmInclude:__CURRENT_PATH__data.html.received_confirm.js
        //-------------------------------------
        var fields="Requestor_Name,Supplier_Name,Quotation,Total_Amount,Status";
        m.fields="_Form,_Print_Version,_Request_ID,"+fields+",Submit_date,Submitted_by,_Lab_Manager_Approval,_Supervisor_Approval,_Financial_Approval,_Received,_Delete";
        //-------------------------------------
        m.cell_render=function(records,I,field,td){
            switch(field){
                case '_Request_ID':
                    td.html(records[I].UID);
                    break;
                case '_Print_Version':
                    td.html("<u style='cursor:pointer'>Print Version</u>");
                    td.find('u').on('click',function(){
                        open_print_page(records[I]);
                    });
                    break;
                case 'Total_Amount':
                    td.html("$"+parseFloat(records[I].Data[field]).toFixed(2));
                    td.css('text-align','right')
                    break;
                case 'Quotation':
                    if(records[I].Data[field] !=undefined) m.set_file_link_s0(records,I,field,td);
                    break;
                case "_Delete":
                    if(records[I].Data.Status=='Submit') td.html('');
                    break;
                case '_Lab_Manager_Approval':
                    if(records[I].Data.Status=='Submit'){
                        td.html("<u style='cursor:pointer'>Approving</u>");
                        td.find('u').on('click',function(){
                            $vm.show_module(m.lab_manager_approval_module,{UID:records[I].UID,A:records[I].A,goback:1,parent:records[I]})
                        });
                    }
                    break;
                case '_Supervisor_Approval':
                    if(records[I].Data.Status=='Submit' ){
                        td.html("<u style='cursor:pointer'>Approving</u>");
                        td.find('u').on('click',function(){
                            $vm.show_module(m.supervisor_approval_module,{UID:records[I].UID,A:records[I].A,goback:1,parent:records[I]})
                        });
                    }
                    break;
                case '_Financial_Approval':
                    if(records[I].Data.Status=='Submit' && parseFloat(records[I].Data.Total_Amount)>3000){
                        td.html("<u style='cursor:pointer'>Approving</u>");
                        td.find('u').on('click',function(){
                            $vm.show_module(m.financial_approval_module,{UID:records[I].UID,A:records[I].A,goback:1,parent:records[I]})
                        });
                    }
                    break;
                case '_Received':
                    td.html("<u style='cursor:pointer'>Notes</u>");
                    td.find('u').on('click',function(){
                        $vm.show_module(m.receive_module,{self:m.self,UID:records[I].UID,A:records[I].A,goback:1,parent:records[I]})
                    });
                    break;
            }
        }
        //-------------------------------------
        var open_print_page=function(record){
            $.get($vm.module_list[m.print].url,function(txt){
                var d=record.Submit_date.substring(0,10).replace(/-/g,'');
                txt=txt.replace('#Purchase Order No#',d+"-"+record.UID);
                txt=txt.replace('#Account No#',record.Data.Supplier_Account_Number);
                txt=txt.replace('#V_Name#',record.Data.Supplier_Name);
                txt=txt.replace('#V_Address#',record.Data.Supplier_Address);
                txt=txt.replace('#V_Phone#',record.Data.Supplier_Phone);
                txt=txt.replace('#V_Fax#',record.Data.Supplier_Fax);
                txt=txt.replace('#D_Name#',record.Data.Requestor_Name);
                txt=txt.replace('#D_Address#',record.Data.Deliver_Address);
               
                txt=txt.replace('#Q_No#',record.Data.Quotation_Number);
                txt=txt.replace('#P_Code#',record.Data.Project_Code);
                
                txt=txt.replace('#Sub Total#',record.Data.Sub_Total);
                txt=txt.replace('#SDelivery#',record.Data.Delivery);
                txt=txt.replace('#GST#',record.Data.GST_Amount);
                txt=txt.replace('#Grand Total#',record.Data.Total_Amount);

                var Items=record.Data.items;
                var Len=Items.length;
                for(var i=0;i<15;i++){
                    var I=i+1;
                    var T1="#No"+I+"#";
                    var T2="#D"+I+"#";
                    var T3="#Q"+I+"#";
                    var T4="#P"+I+"#";
                    var T5="#A"+I+"#";
                    var T6="#C"+I+"#";
                    var T7="#Nm"+I+"#";
                    if(i<Len){
                        txt=txt.replace(T1,Items[i].Item_No);
                        txt=txt.replace(T2,Items[i].Description);
                        txt=txt.replace(T3,Items[i].Unit_Price);
                        txt=txt.replace(T4,Items[i].Quantity);
                        txt=txt.replace(T5,Items[i].Amount);
                        txt=txt.replace(T6,Items[i].Project_Code);
                        txt=txt.replace(T7,Items[i].Name_of_person_ordering);
                    }
                    else{
                        txt=txt.replace(T1,'&nbsp;');
                        txt=txt.replace(T2,'&nbsp;');
                        txt=txt.replace(T3,'&nbsp;');
                        txt=txt.replace(T4,'&nbsp;');
                        txt=txt.replace(T5,'&nbsp;');
                        txt=txt.replace(T6,'&nbsp;');
                        txt=txt.replace(T7,'&nbsp;');
                    }
                    var V1=record.Data.Total_Amount
                }


                txt=txt.replace(/undefined/g,'');
                
                
                
                
                var w=window.open('');
                w.document.title="print version";
                w.document.body.innerHTML=txt;
            },'text');
        }
        m.load=function(){
            if(m.self==1) m.options={self:1};
        }
        //-------------------------------------
        m.before_submit=function(data,index){
            if(m.input==undefined){
                index.A=$vm.user_name; 
            }
            return true;
        }
        //-------------------------------------
        m.data_process=function(){
            var options={};
            if(m.self==1) options={self:1};
            var uid_array=[];
            for(var i=0;i<m.records.length;i++){
                uid_array.push(m.records[i].UID)
            }
            var query={ I2: { $in: uid_array } }
            load_lab_manager_approval(query,options);
            load_supervisor_approval(query,options);
            load_financial_approval(query,options);
            load_received_confirm(query,options);
        }
        //-------------------------------------
    }
</script>
<style>
    #nav__ID a{
        text-decoration-line: underline;
    }
    VmInclude:__COMPONENT__/g/grid.01.css
</style>
